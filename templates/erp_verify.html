<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>ERP ì¬ê³  ê²€ì¦</title>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>ERP ì¬ê³  ê²€ì¦</h2>

    <p class="small">
      ERP í˜„ì¬ê³  ì—‘ì…€(.xlsx)ì„ ì—…ë¡œë“œí•˜ë©´ WMS ì¬ê³ ì™€ ë¹„êµí•©ë‹ˆë‹¤.<br/>
      ë¹„êµí‚¤ëŠ” í’ˆë²ˆ/LOT/ê·œê²©ì´ ìˆëŠ” ë§Œí¼ ì‚¬ìš©í•˜ë©°,
      ë‹¨ìœ„ê°€ ë‹¤ë¥´ë©´ í’ˆë²ˆ ë‹¨ìœ„ë¡œ í•©ì‚° ë¹„êµí•©ë‹ˆë‹¤.
    </p>

    {% if error %}
      <div style="padding:10px; border:1px solid #ef4444; border-radius:10px; margin:10px 0;">
        âŒ {{ error }}
      </div>
    {% endif %}

    <!-- ì—…ë¡œë“œ í¼ -->
    <form method="post" enctype="multipart/form-data" style="margin-top:12px;">
      <label>ERP í˜„ì¬ê³  ì—‘ì…€</label>
      <input type="file" name="file" accept=".xlsx" required/>
      <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" type="submit">ì—…ë¡œë“œ & ë¹„êµ</button>
        <a class="btn secondary" href="/">ë©”ì¸</a>
      </div>
    </form>

    {% if result %}
      <hr style="margin:16px 0; opacity:0.25;"/>

      <!-- ìš”ì•½ -->
      <div class="grid2">
        <div><b>ì´ ë¹„êµ í–‰</b><br/>{{ result.summary.total }}</div>
        <div><b>âœ… ì¼ì¹˜</b><br/>{{ result.summary.match }}</div>
        <div><b>âš ï¸ ì°¨ì´</b><br/>{{ result.summary.diff }}</div>
        <div><b>âŒ WMS ì—†ìŒ</b><br/>{{ result.summary.wms_missing }}</div>
        <div><b>âŒ ERP ì—†ìŒ</b><br/>{{ result.summary.erp_missing }}</div>
        <div><b>â“ ë‹¨ìœ„ì°¨ì´(ë¡¤ì—…)</b><br/>{{ result.summary.rollup }}</div>
      </div>

      <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
      <div style="margin-top:12px;">
        <button id="btnExcel" class="btn">ğŸ“¥ ê²€ì¦ ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- ê²°ê³¼ í…Œì´ë¸” -->
      <div style="overflow:auto; margin-top:14px;">
        <table id="resultTable">
          <thead>
            <tr>
              <th>ìƒíƒœ</th>
              <th>ë¹„êµë‹¨ìœ„</th>
              <th>í’ˆë²ˆ</th>
              <th>LOT</th>
              <th>ê·œê²©</th>
              <th style="text-align:right;">ERP ìˆ˜ëŸ‰</th>
              <th style="text-align:right;">WMS ìˆ˜ëŸ‰</th>
              <th style="text-align:right;">ì°¨ì´(ERP-WMS)</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody>
            {% for r in result.rows %}
              <tr>
                <td>{{ r.status }}</td>
                <td>{{ r.mode }}</td>
                <td>{{ r.item_code }}</td>
                <td>{{ r.lot }}</td>
                <td>{{ r.spec }}</td>
                <td style="text-align:right;">{{ r.erp_qty }}</td>
                <td style="text-align:right;">{{ r.wms_qty }}</td>
                <td style="text-align:right;">{{ r.diff }}</td>
                <td class="small">{{ r.note }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>

{% if result %}
<script>
document.getElementById("btnExcel").onclick = async () => {
  const rows = [];
  const trs = document.querySelectorAll("#resultTable tbody tr");

  trs.forEach(tr => {
    const tds = tr.querySelectorAll("td");
    rows.push({
      status: tds[0].innerText.trim(),
      mode: tds[1].innerText.trim(),
      item_code: tds[2].innerText.trim(),
      lot: tds[3].innerText.trim(),
      spec: tds[4].innerText.trim(),
      erp_qty: Number(tds[5].innerText.trim()),
      wms_qty: Number(tds[6].innerText.trim()),
      diff: Number(tds[7].innerText.trim()),
      note: tds[8].innerText.trim(),
    });
  });

  if (!rows.length) {
    alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const res = await fetch("/api/erp/verify/download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(rows),
  });

  if (!res.ok) {
    alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
    return;
  }

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "erp_verify_result.xlsx";
  a.click();

  window.URL.revokeObjectURL(url);
};
</script>
{% endif %}

</body>
</html>
