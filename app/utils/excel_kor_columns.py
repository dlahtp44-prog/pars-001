from typing import Dict, List, Tuple

# =====================================================
# ì¶œê³  ì—‘ì…€ í•œê¸€ ì»¬ëŸ¼ ì •ì˜ (ìˆ˜ëŸ‰ë§Œ í•„ìˆ˜)
# =====================================================

# ðŸ”¥ í•„ìˆ˜ ì»¬ëŸ¼
REQUIRED = ["ìˆ˜ëŸ‰"]

# ì„ íƒ ì»¬ëŸ¼ (ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¬´ì‹œ)
OPTIONAL = [
    "ì°½ê³ ",
    "ë¡œì¼€ì´ì…˜",
    "ë¸Œëžœë“œ",
    "í’ˆë²ˆ",
    "í’ˆëª…",
    "LOT",
    "ê·œê²©",
    "ë¹„ê³ ",
]


# =====================================================
# í—¤ë” ì •ê·œí™”
# =====================================================

def normalize_header(s: str) -> str:
    if s is None:
        return ""

    s = str(s).strip()
    s = s.replace(" ", "")

    mapping = {
        # ì°½ê³ 
        "ì°½ê³ ": "ì°½ê³ ", "WAREHOUSE": "ì°½ê³ ", "Warehouse": "ì°½ê³ ",
        # ë¡œì¼€ì´ì…˜
        "ë¡œì¼€ì´ì…˜": "ë¡œì¼€ì´ì…˜", "LOCATION": "ë¡œì¼€ì´ì…˜", "Loc": "ë¡œì¼€ì´ì…˜",
        # ë¸Œëžœë“œ
        "ë¸Œëžœë“œ": "ë¸Œëžœë“œ", "BRAND": "ë¸Œëžœë“œ", "Brand": "ë¸Œëžœë“œ",
        # í’ˆë²ˆ / í’ˆëª…
        "í’ˆë²ˆ": "í’ˆë²ˆ", "ITEMCODE": "í’ˆë²ˆ", "ItemCode": "í’ˆë²ˆ",
        "í’ˆëª…": "í’ˆëª…", "ITEMNAME": "í’ˆëª…", "ItemName": "í’ˆëª…",
        # LOT / ê·œê²© / ìˆ˜ëŸ‰ / ë¹„ê³ 
        "LOT": "LOT", "Lot": "LOT",
        "ê·œê²©": "ê·œê²©", "SPEC": "ê·œê²©", "Spec": "ê·œê²©",
        "ìˆ˜ëŸ‰": "ìˆ˜ëŸ‰", "QTY": "ìˆ˜ëŸ‰", "Qty": "ìˆ˜ëŸ‰", "ìˆ˜ëŸ‰(PCS)": "ìˆ˜ëŸ‰",
        "ë¹„ê³ ": "ë¹„ê³ ", "NOTE": "ë¹„ê³ ", "Note": "ë¹„ê³ ",
    }

    return mapping.get(s, s)


# =====================================================
# ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë¹Œë“œ
# =====================================================

def build_col_index(headers: List[str]) -> Dict[str, int]:
    idx = {}
    for i, h in enumerate(headers):
        nh = normalize_header(h)
        if nh and nh not in idx:
            idx[nh] = i
    return idx


# =====================================================
# í•„ìˆ˜ ì»¬ëŸ¼ ê²€ì¦
# =====================================================

def validate_required(idx: Dict[str, int]) -> Tuple[bool, List[str]]:
    missing = [c for c in REQUIRED if c not in idx]
    return (len(missing) == 0, missing)
