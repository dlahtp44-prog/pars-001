<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>제품 선택</title>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>제품 선택</h2>
    <p class="small">출발 로케이션: <b>{{ from_location }}</b></p>

    {% if rows|length == 0 %}
      <p>해당 로케이션에 재고가 없습니다.</p>
      <p class="small"><a href="/m/move/from">← 출발 로케이션 다시</a></p>
    {% else %}
    <form method="post" action="/m/move/select/submit" id="moveForm">
      <input type="hidden" name="from_location" value="{{ from_location }}">

      <table>
        <thead>
          <tr>
            <th>선택</th>
            <th>품번</th>
            <th>LOT</th>
            <th style="text-align:right">재고</th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td>
              <input type="radio"
                     name="inventory_id"
                     value="{{ r.id }}"
                     data-qty="{{ r.qty }}"
                     required>
            </td>
            <td>{{ r.item_code }}</td>
            <td>{{ r.lot or '-' }}</td>
            <td style="text-align:right">{{ r.qty }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:12px;">
        <p class="small">선택 재고: <b id="availQty">-</b></p>

        <label>이동 수량 (소수점 가능)</label>
        <input type="number"
               id="qty_input"
               name="qty_raw"
               step="any"
               inputmode="decimal"
               required>

        <label>작업자</label>
        <input name="operator" required>

        <label>비고</label>
        <input name="note">

        <button type="submit" id="submitBtn" style="width:100%; margin-top:10px;">
          다음 (도착지 스캔)
        </button>
      </div>
    </form>

    <p class="small"><a href="/m/move/from">← 출발 로케이션 다시</a></p>

    <script>
      (function(){
        const availEl = document.getElementById("availQty");
        const qtyInput = document.getElementById("qty_input");
        const form = document.getElementById("moveForm");
        const submitBtn = document.getElementById("submitBtn");
        let available = 0;

        document.querySelectorAll("input[name='inventory_id']").forEach(r => {
          r.addEventListener("change", () => {
            available = parseFloat((r.dataset.qty || "0").toString().replace(/,/g, ""));
            availEl.textContent = available.toLocaleString();
          });
        });

        form.addEventListener("submit", (e) => {
          const q = parseFloat((qtyInput.value || "0").toString().replace(/,/g, ""));
          
          if (available <= 0) {
            alert("제품을 선택하세요.");
            e.preventDefault();
            return;
          }
          if (isNaN(q) || q <= 0) {
            alert("이동 수량을 올바르게 입력하세요.");
            e.preventDefault();
            return;
          }
          if (q > available) {
            alert("수량이 재고를 초과했습니다.");
            e.preventDefault();
            return;
          }

          // 중복 클릭 방지
          submitBtn.disabled = true;
          submitBtn.innerText = "처리 중...";
        });
      })();
    </script>
    {% endif %}
  </div>
</div>
</body>
</html>
