<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <title>이동 - 출발 로케이션 스캔</title>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>재고 이동 (QR)</h2>
    <p class="muted">1) 출발 로케이션 QR을 스캔하세요.</p>

    <label>창고</label>
    <input id="warehouse" placeholder="예: 서이천" value="서이천">

    <div id="reader" style="width:100%;max-width:360px;margin:12px auto;"></div>

    <div class="actions">
      <a class="btn ghost" href="/">메인</a>
    </div>

    <div id="msg" class="notice" style="display:none;"></div>
  </div>
</div>

<script>
const msg = document.getElementById('msg');
function showMsg(t){ msg.style.display='block'; msg.textContent=t; }

function extractLocation(raw){
  raw = (raw||'').trim();
  if(raw.includes('location=')){
    try{
      const q = raw.split('location=')[1];
      raw = q.split('&')[0];
    }catch(e){}
  }
  if(raw.includes('type=') || raw.includes('item_code=') || raw.includes('&') || raw.includes('=')) return '';
  if(raw.length>60) return '';
  if(!/^[A-Za-z0-9\-_/]+$/.test(raw)) return '';
  return raw;
}

const qr = new Html5Qrcode("reader");
qr.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 220 },
  (decodedText)=>{
    const loc = extractLocation(decodedText);
    if(!loc){ showMsg('출발 로케이션 QR이 아닙니다. 로케이션 QR을 스캔하세요.'); return; }
    const wh = document.getElementById('warehouse').value || '';
    window.location.href = `/m/move/select?warehouse=${encodeURIComponent(wh)}&from_location=${encodeURIComponent(loc)}`;
  },
  ()=>{}
).catch(()=>showMsg('카메라 접근이 차단되었습니다.'));
</script>
</body>
</html>
