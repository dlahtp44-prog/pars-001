<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>{{ title or "QR ìŠ¤ìº”" }}</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>{{ title or "QR ìŠ¤ìº”" }}</h2>
    {% if desc %}<p class="small">{{ desc }}</p>{% endif %}

    <div id="reader" style="width:100%"></div>

    <form id="qrForm" method="post" action="{{ action or '/m/qr/submit' }}">
      <input id="qrtext" name="qrtext" type="hidden" value="">

      {# ğŸ”‘ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ #}
      {% if mode %}
        <input type="hidden" name="mode" value="{{ mode }}">
      {% endif %}
      {% if warehouse %}
        <input type="hidden" name="warehouse" value="{{ warehouse }}">
      {% endif %}

      {% if hidden %}
        {% for k, v in hidden.items() %}
          <input type="hidden" name="{{ k }}" value="{{ v }}">
        {% endfor %}
      {% endif %}
    </form>

    <div class="grid" style="margin-top:12px;">
      <button type="button" id="toggleBtn">ì¹´ë©”ë¼ ì „í™˜</button>
      <button type="button" id="restartBtn">ë‹¤ì‹œ ì‹œì‘</button>
    </div>

    <p class="small" style="margin-top:10px;">
      ìŠ¤ìº”ì´ ì•ˆë˜ë©´ <b>ë¸Œë¼ìš°ì € ì¹´ë©”ë¼ ê¶Œí•œ</b>ì„ í™•ì¸í•˜ì„¸ìš”. (HTTPS í•„ìš”)
    </p>
    <p class="small"><a href="/m">â† ëª¨ë°”ì¼</a></p>
  </div>
</div>

<script>
(function(){
  const qr = new Html5Qrcode("reader");
  const qrtextEl = document.getElementById("qrtext");
  const formEl = document.getElementById("qrForm");
  const toggleBtn = document.getElementById("toggleBtn");
  const restartBtn = document.getElementById("restartBtn");

  let cameras = [];
  let camIndex = 0;
  let running = false;
  let submitted = false;   // âœ… ì¤‘ë³µ submit ë°©ì§€

  const config = { fps: 10, qrbox: { width: 260, height: 260 } };

  function submitText(text){
    if(submitted) return;
    const cleaned = (text || "").trim();
    if(!cleaned) return;

    submitted = true;
    qrtextEl.value = cleaned;
    formEl.submit();
  }

  async function stop(){
    if(running){
      try{ await qr.stop(); }catch(e){}
      running = false;
    }
  }

  async function startWithFacingMode(){
    try{
      await qr.start({ facingMode: { exact: "environment" } }, config, submitText);
      running = true;
      return true;
    }catch(e){
      try{
        await qr.start({ facingMode: "environment" }, config, submitText);
        running = true;
        return true;
      }catch(e2){
        return false;
      }
    }
  }

  async function startWithDeviceId(deviceId){
    await qr.start({ deviceId: { exact: deviceId } }, config, submitText);
    running = true;
  }

  async function start(){
    submitted = false;
    await stop();

    const ok = await startWithFacingMode();
    if(ok) return;

    try{
      cameras = await Html5Qrcode.getCameras();
      if(!cameras || cameras.length === 0){
        alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      let idx = cameras.length - 1;
      for(let i=0;i<cameras.length;i++){
        const label = (cameras[i].label || "").toLowerCase();
        if(label.includes("back") || label.includes("rear")){
          idx = i; break;
        }
      }
      camIndex = idx;
      await startWithDeviceId(cameras[camIndex].id);
    }catch(err){
      alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + err);
    }
  }

  toggleBtn.addEventListener("click", async ()=>{
    try{
      cameras = cameras && cameras.length ? cameras : await Html5Qrcode.getCameras();
      if(!cameras || cameras.length < 2){
        alert("ì „í™˜í•  ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      camIndex = (camIndex + 1) % cameras.length;
      await stop();
      submitted = false;
      await startWithDeviceId(cameras[camIndex].id);
    }catch(e){
      alert("ì¹´ë©”ë¼ ì „í™˜ ì‹¤íŒ¨: " + e);
    }
  });

  restartBtn.addEventListener("click", start);
  window.addEventListener("beforeunload", stop);

  start();
})();
</script>
</body>
</html>
