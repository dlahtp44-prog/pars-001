<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>ì´ˆê¸° ì¬ê³  ì„¸íŒ… | PARS WMS</title>

  <style>
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1; min-width:240px; }

    .box {
      border: 1px solid #2a2f3a;
      border-radius: 14px;
      padding: 14px;
      background: #12151c;
      margin-top: 12px;
    }

    .badge2 {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.12);
      margin-right:6px;
    }
    .b-ok { background: rgba(39, 174, 96, 0.18); color:#7dffb2; }
    .b-err { background: rgba(231, 76, 60, 0.18); color:#ff9f96; }
    .b-warn { background: rgba(241, 196, 15, 0.14); color:#ffd26a; }

    .btnline { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .btnline button, .btnline a { flex:1; }

    .mini { font-size:12px; color:#9aa3b5; line-height:1.5; }

    table { font-size: 13px; }
    td, th { white-space: nowrap; }
    td.wrap { white-space: normal; }
    .scroll { overflow:auto; max-height: 420px; border-radius: 12px; border:1px solid #2a2f3a; }

    .danger {
      border:1px solid rgba(255,107,107,0.35);
      background: rgba(255,107,107,0.10);
      color:#ffb3b3;
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 10px;
      font-weight: 800;
    }
  </style>
</head>

<body>
<div class="container">
  <div class="card">

    <div class="header-bar">
      <h2>ğŸ§™â€â™‚ï¸ ì´ˆê¸° ì¬ê³  ì„¸íŒ… (ë§ˆë²•ì‚¬)</h2>
      <a href="/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <div class="danger">
      âš ï¸ ì£¼ì˜: ì´ ê¸°ëŠ¥ì€ â€œìš´ì˜ ì…ê³ â€ê°€ ì•„ë‹ˆë¼ â€œì´ˆê¸° ì¬ê³  ì„¸íŒ…â€ì…ë‹ˆë‹¤. <br/>
      ë°˜ì˜ ì‹œ ì´ë ¥ì€ <b>type=ì´ˆê¸°ì¬ê³ </b>, from_location=INIT ìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.
    </div>

    <!-- ì…ë ¥ -->
    <div class="box">
      <div class="row">
        <div>
          <label>ì‘ì—…ì(ê´€ë¦¬ì)</label>
          <input id="operator" type="text" placeholder="ì˜ˆ: ì´ëª¨ì„¸" required>
          <div class="mini">â€» commit ì‹œ í•„ìˆ˜</div>
        </div>

        <div>
          <label>ì´ˆê¸° ì¬ê³  ì—‘ì…€ (ê¸°ì¡´ ì…ê³  ì–‘ì‹ê³¼ ë™ì¼)</label>
          <input id="file" type="file" accept=".xlsx" required>
          <div class="mini">í•„ìˆ˜ ì»¬ëŸ¼: ì°½ê³ , ë¡œì¼€ì´ì…˜, í’ˆë²ˆ, LOT, ê·œê²©, ìˆ˜ëŸ‰</div>
        </div>

        <div>
          <label>ê°•ì œ ì§„í–‰(force)</label>
          <select id="force">
            <option value="0">ê¶Œì¥(ì¬ê³  0ê±´ì¼ ë•Œë§Œ)</option>
            <option value="1">ê°•ì œ(ê¸°ì¡´ ì¬ê³  ìˆì–´ë„ ëˆ„ì  ë°˜ì˜)</option>
          </select>
          <div class="mini">â€» inventoryê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê¶Œì¥ ëª¨ë“œì—ì„œ ë§‰í™ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="btnline">
        <button id="btnPreview" type="button">1) ì—…ë¡œë“œ & ê²€ì¦(ë¯¸ë¦¬ë³´ê¸°)</button>
        <button id="btnCommit" type="button" disabled>2) ì´ˆê¸°ì¬ê³  ë°˜ì˜(ì»¤ë°‹)</button>
        <a class="menu-btn" href="/" style="margin:0;">ë©”ì¸</a>
      </div>

      <div class="mini" style="margin-top:10px;">
        ì»¤ë°‹ì€ ë‚´ë¶€ì ìœ¼ë¡œ <b>confirm=INIT-CONFIRM</b>ìœ¼ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ìš”ì•½ -->
    <div id="summaryBox" class="box" style="display:none;">
      <div>
        <span class="badge2 b-ok">ì •ìƒ</span> <b id="okCount">0</b> í–‰
        &nbsp;&nbsp;
        <span class="badge2 b-err">ì˜¤ë¥˜</span> <b id="errCount">0</b> í–‰
        &nbsp;&nbsp;
        <span class="badge2 b-warn">í˜„ì¬ DB</span>
        inventory: <b id="invCount">0</b> / history: <b id="hisCount">0</b>
      </div>
      <div class="mini" id="msg" style="margin-top:6px;"></div>
    </div>

    <!-- ì˜¤ë¥˜ í–‰ í‘œì‹œ -->
    <div id="errBox" class="box" style="display:none;">
      <h3 style="margin:0 0 10px 0;">âŒ ì˜¤ë¥˜ í–‰</h3>
      <div class="scroll">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
          <tr>
            <th style="text-align:left;">row</th>
            <th style="text-align:left;">error</th>
            <th style="text-align:left;">raw</th>
          </tr>
          </thead>
          <tbody id="errTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ì •ìƒ í–‰ ë¯¸ë¦¬ë³´ê¸° -->
    <div id="okBox" class="box" style="display:none;">
      <h3 style="margin:0 0 10px 0;">âœ… ì •ìƒ í–‰(ë¯¸ë¦¬ë³´ê¸°)</h3>
      <div class="mini">â€» í™”ë©´ì—ëŠ” ìµœëŒ€ 2000í–‰ê¹Œì§€ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="scroll" style="margin-top:10px;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
          <tr>
            <th>ì°½ê³ </th>
            <th>ë¡œì¼€ì´ì…˜</th>
            <th>ë¸Œëœë“œ</th>
            <th>í’ˆë²ˆ</th>
            <th>í’ˆëª…</th>
            <th>LOT</th>
            <th>ê·œê²©</th>
            <th style="text-align:right;">ìˆ˜ëŸ‰</th>
            <th>ë¹„ê³ </th>
          </tr>
          </thead>
          <tbody id="okTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ì»¤ë°‹ ê²°ê³¼ -->
    <div id="commitBox" class="box" style="display:none;">
      <h3 style="margin:0 0 10px 0;">ğŸ“Œ ë°˜ì˜ ê²°ê³¼</h3>
      <pre id="commitOut" style="white-space:pre-wrap; margin:0;"></pre>
    </div>

  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

const fileEl = $("file");
const operatorEl = $("operator");
const forceEl = $("force");
const btnPreview = $("btnPreview");
const btnCommit = $("btnCommit");

const summaryBox = $("summaryBox");
const okBox = $("okBox");
const errBox = $("errBox");
const commitBox = $("commitBox");

const okTbody = $("okTbody");
const errTbody = $("errTbody");

let lastPreviewOkRows = 0;

// -----------------------------
// helper
// -----------------------------
function esc(s){
  s = (s ?? "").toString();
  return s.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function setLoading(btn, on){
  btn.disabled = on;
  btn.textContent = on ? "ì²˜ë¦¬ì¤‘..." : btn.dataset.label;
}

btnPreview.dataset.label = btnPreview.textContent;
btnCommit.dataset.label = btnCommit.textContent;

// -----------------------------
// 1) Preview
// -----------------------------
btnPreview.addEventListener("click", async () => {
  commitBox.style.display = "none";
  btnCommit.disabled = true;

  const f = fileEl.files?.[0];
  if (!f) { alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"); return; }

  setLoading(btnPreview, true);

  try {
    const fd = new FormData();
    fd.append("file", f);

    const res = await fetch("/api/init/preview", { method:"POST", body: fd });
    const data = await res.json();

    if (!res.ok) {
      alert(data?.detail || "ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨");
      return;
    }

    // summary
    summaryBox.style.display = "block";
    $("okCount").textContent = data.summary.ok_rows;
    $("errCount").textContent = data.summary.error_rows;
    $("invCount").textContent = data.inventory_count;
    $("hisCount").textContent = data.history_count;
    $("msg").textContent = data.message || "";

    // table render
    okTbody.innerHTML = "";
    errTbody.innerHTML = "";

    // ok rows
    const okRows = data.rows_ok || [];
    lastPreviewOkRows = okRows.length;

    if (okRows.length) {
      okBox.style.display = "block";
      okRows.slice(0, 2000).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.warehouse)}</td>
          <td>${esc(r.location)}</td>
          <td>${esc(r.brand)}</td>
          <td><b>${esc(r.item_code)}</b></td>
          <td class="wrap">${esc(r.item_name)}</td>
          <td>${esc(r.lot)}</td>
          <td>${esc(r.spec)}</td>
          <td style="text-align:right;"><b>${esc(r.qty)}</b></td>
          <td class="wrap">${esc(r.note)}</td>
        `;
        okTbody.appendChild(tr);
      });
    } else {
      okBox.style.display = "none";
    }

    // err rows
    const errRows = data.rows_error || [];
    if (errRows.length) {
      errBox.style.display = "block";
      errRows.slice(0, 500).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.rownum)}</td>
          <td class="wrap">${esc(r.error)}</td>
          <td class="wrap"><code>${esc(JSON.stringify(r.raw))}</code></td>
        `;
        errTbody.appendChild(tr);
      });
    } else {
      errBox.style.display = "none";
    }

    // commit button enable ì¡°ê±´
    if (lastPreviewOkRows > 0) {
      btnCommit.disabled = false;
    }

  } catch (e) {
    alert("ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    console.error(e);
  } finally {
    setLoading(btnPreview, false);
  }
});

// -----------------------------
// 2) Commit
// -----------------------------
btnCommit.addEventListener("click", async () => {
  const f = fileEl.files?.[0];
  if (!f) { alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"); return; }
  const operator = operatorEl.value.trim();
  if (!operator) { alert("ì‘ì—…ì(ê´€ë¦¬ì)ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }

  const force = forceEl.value;

  if (!confirm("ì •ë§ë¡œ ì´ˆê¸°ì¬ê³ ë¥¼ ë°˜ì˜í• ê¹Œìš”? (ì´ ì‘ì—…ì€ ì´ë ¥ì— ê¸°ë¡ë©ë‹ˆë‹¤)")) return;

  setLoading(btnCommit, true);

  try {
    const fd = new FormData();
    fd.append("file", f);
    fd.append("operator", operator);
    fd.append("confirm", "INIT-CONFIRM"); // âœ… ë³´í˜¸ë¬¸êµ¬
    fd.append("force", force);

    const res = await fetch("/api/init/commit", { method:"POST", body: fd });
    const text = await res.text();

    commitBox.style.display = "block";
    $("commitOut").textContent = text;

    if (!res.ok) {
      alert("ì»¤ë°‹ ì‹¤íŒ¨. ì•„ë˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }

    alert("ì´ˆê¸°ì¬ê³  ë°˜ì˜ ì™„ë£Œ!");
    btnCommit.disabled = true;

  } catch (e) {
    alert("ì»¤ë°‹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    console.error(e);
  } finally {
    setLoading(btnCommit, false);
  }
});
</script>
</body>
</html>
