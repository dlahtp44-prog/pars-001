<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>출고 | PARS WMS</title>

  <style>
    .form-row { margin-bottom: 10px; }
    .form-row label { display:inline-block; width:90px; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      max-width: 800px;
      margin: 8% auto;
      padding: 15px;
      border-radius: 8px;
    }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    tr:hover { background:#f3f4f6; cursor:pointer; }
  </style>
</head>

<body>
<div class="container">
  <div class="card">

    <div class="header-bar">
      <h2>출고</h2>
      <a href="/logout" class="logout-btn">로그아웃</a>
    </div>

    <form id="f">
      <div class="form-row">
        <label>창고</label>
        <!-- ✅ readonly + id 추가 -->
        <input id="warehouse" name="warehouse" readonly required>
      </div>

      <div class="form-row">
        <label>작업자</label>
        <input name="operator" required>
      </div>

      <div class="form-row">
        <label>품번</label>
        <input id="item_code" name="item_code" required>
        <button type="button" id="btnSelectStock">출고재고선택</button>
      </div>

      <div class="form-row">
        <label>로케이션</label>
        <input id="location" name="location" readonly required>
      </div>

      <div class="form-row">
        <label>브랜드</label>
        <input id="brand" name="brand" readonly>
      </div>

      <div class="form-row">
        <label>품명</label>
        <input id="item_name" name="item_name" readonly>
      </div>

      <div class="form-row">
        <label>LOT</label>
        <input id="lot" name="lot" readonly required>
      </div>

      <div class="form-row">
        <label>규격</label>
        <input id="spec" name="spec" readonly required>
      </div>

      <div class="form-row">
        <label>수량</label>
        <input id="qty" name="qty" type="number" step="0.001" required>
        <span id="remainQty" style="margin-left:8px;color:#555;">남은 재고: -</span>
      </div>

      <div class="form-row">
        <label>비고</label>
        <input name="note">
      </div>

      <button id="submitBtn" type="submit" disabled>출고 처리</button>
    </form>

    <pre id="out" class="card" style="white-space:pre-wrap"></pre>
    <p><a href="/">← 메인</a></p>
  </div>
</div>

<!-- =====================
     출고 재고 선택 모달
===================== -->
<div id="stockModal" class="modal">
  <div class="modal-content">
    <h3>출고 재고 선택</h3>
    <table id="stockTable">
      <thead>
        <tr>
          <th>로케이션</th>
          <th>LOT</th>
          <th>규격</th>
          <th>현재고</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="text-align:right;margin-top:10px;">
      <button type="button" id="btnCloseModal">닫기</button>
    </div>
  </div>
</div>

<script>
let selectedQty = null;

const f = document.getElementById("f");
const itemCode = document.getElementById("item_code");
const warehouse = document.getElementById("warehouse"); // ✅ 추가
const modal = document.getElementById("stockModal");
const tbody = document.querySelector("#stockTable tbody");
const qtyInput = document.getElementById("qty");
const remainQty = document.getElementById("remainQty");
const submitBtn = document.getElementById("submitBtn");
const out = document.getElementById("out");

/* =====================
   재고 선택 모달 열기
===================== */
document.getElementById("btnSelectStock").onclick = async () => {
  const code = itemCode.value.trim();
  if (!code) {
    alert("품번을 먼저 입력하세요");
    return;
  }

  const res = await fetch(`/api/inventory/by-item?item_code=${encodeURIComponent(code)}`);
  const data = await res.json();

  tbody.innerHTML = "";
  if (!data.items.length) {
    alert("출고 가능한 재고가 없습니다");
    return;
  }

  data.items.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.location}</td>
      <td>${r.lot}</td>
      <td>${r.spec}</td>
      <td>${r.qty}</td>
    `;
    tr.onclick = () => {
      warehouse.value = r.warehouse;   // ✅ 핵심 수정
      location.value = r.location;
      brand.value = r.brand;
      item_name.value = r.item_name;
      lot.value = r.lot;
      spec.value = r.spec;

      selectedQty = Number(r.qty);
      qtyInput.max = selectedQty;
      remainQty.textContent = `남은 재고: ${selectedQty}`;

      submitBtn.disabled = false;
      modal.style.display = "none";
      qtyInput.focus();
    };
    tbody.appendChild(tr);
  });

  modal.style.display = "block";
};

document.getElementById("btnCloseModal").onclick = () => {
  modal.style.display = "none";
};

/* =====================
   수량 초과 방지
===================== */
qtyInput.addEventListener("input", () => {
  const v = Number(qtyInput.value);
  if (!selectedQty || v <= 0 || v > selectedQty) {
    submitBtn.disabled = true;
    qtyInput.setCustomValidity(`출고 수량은 ${selectedQty} 이하로 입력하세요`);
  } else {
    qtyInput.setCustomValidity("");
    submitBtn.disabled = false;
  }
});

/* =====================
   출고 처리
===================== */
f.addEventListener("submit", async (e) => {
  e.preventDefault();
  submitBtn.disabled = true;
  out.textContent = "처리중...";

  try {
    const fd = new FormData(f);
    const res = await fetch("/api/outbound", { method: "POST", body: fd });
    out.textContent = await res.text();
  } catch {
    out.textContent = "❌ 출고 처리 중 오류 발생";
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>
